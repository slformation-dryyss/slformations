generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(cuid())
  auth0Id                String                 @unique
  email                  String                 @unique
  name                   String?
  firstName              String?
  lastName               String?
  phone                  String?
  birthDate              DateTime?
  addressLine1           String?
  addressLine2           String?
  postalCode             String?
  city                   String?
  country                String?
  profession             String?
  employerName           String?
  wantsVtcTraining       Boolean?
  wantsTaxiTraining      Boolean?
  nationalIdNumber       String?
  drivingLicenseNumber   String?
  drivingLicenseType     String?
  drivingLicenseIssuedAt DateTime?
  lastLoginAt            DateTime?
  stripeCustomerId       String?                @unique
  isProfileComplete      Boolean                @default(false)
  role                   String                 @default("STUDENT")
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  badges                 String[]               @default([])
  bio                    String?
  diplomas               String[]               @default([])
  onboardingStatus       String                 @default("NEW")
  gdprConsent            Boolean?
  gdprConsentDate        DateTime?
  marketingConsent       Boolean?
  roles                  String[]               @default(["STUDENT"])
  primaryRole            String                 @default("STUDENT")
  mustChangePassword     Boolean                @default(false)
  passwordChangedAt      DateTime?
  addresses              Address[]
  bookings               Booking[]
  studentChangeRequests  ChangeRequest[]        @relation("StudentChangeRequests")
  consentLogs            ConsentLog[]
  mainSessions           CourseSession[]        @relation("MainTeacher")
  courseSessionBookings  CourseSessionBooking[]
  dataExportRequests     DataExportRequest[]
  studentLessons         DrivingLesson[]        @relation("StudentLessons")
  enrollments            Enrollment[]
  studentAssignments     InstructorAssignment[] @relation("StudentAssignments")
  instructorProfile      InstructorProfile?
  progress               LessonProgress[]
  orders                 Order[]
  paymentLinks           PaymentLink[]
  quizAttempts           QuizAttempt[]
  sessionsTeaching       Session[]              @relation("TeacherSessions")
  sessionBookings        SessionBooking[]
  teachingSlots          SessionSlot[]
  teacherProfile         TeacherProfile?
  documents              UserDocument[]
}

model TeacherProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  specialties    String[] @default([])
  certifications String[] @default([])
  city           String
  department     String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Course {
  id             String             @id @default(cuid())
  title          String
  slug           String?            @unique
  description    String
  price          Float              @default(0)
  imageUrl       String?
  isPublished    Boolean            @default(false)
  type           String             @default("VTC")
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  maxStudents    Int?               @default(0)
  bookings       Booking[]
  categories     CourseOnCategory[]
  courseSessions CourseSession[]
  enrollments    Enrollment[]
  modules        Module[]
  orders         Order[]
  orderItems     OrderItem[]
  paymentLinks   PaymentLink[]
  quizzes        Quiz[]
  sessions       Session[]

  @@index([type])
  @@index([isPublished, type])
}

model CourseCategory {
  id          String             @id @default(cuid())
  slug        String             @unique
  name        String
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  courses     CourseOnCategory[]
}

model CourseOnCategory {
  courseId   String
  categoryId String
  assignedAt DateTime       @default(now())
  category   CourseCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  course     Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([courseId, categoryId])
  @@index([categoryId])
}

model Module {
  id           String        @id @default(cuid())
  title        String
  description  String?
  position     Int           @default(0)
  isPublished  Boolean       @default(false)
  courseId     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  dayNumber    Int?
  duration     Int?
  lessons      Lesson[]
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz         Quiz?
  sessionSlots SessionSlot[]

  @@index([courseId, position])
}

model Lesson {
  id          String           @id @default(cuid())
  title       String
  description String?
  videoUrl    String?
  content     String?
  position    Int              @default(0)
  isPublished Boolean          @default(false)
  isFree      Boolean          @default(false)
  duration    Int              @default(0)
  moduleId    String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  module      Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress    LessonProgress[]

  @@index([moduleId, position])
}

model CourseSession {
  id            String                 @id @default(cuid())
  courseId      String
  startDate     DateTime
  endDate       DateTime
  location      String?
  maxSpots      Int                    @default(10)
  bookedSpots   Int                    @default(0)
  isPublished   Boolean                @default(true)
  mainTeacherId String?
  meetingUrl    String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  course        Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  mainTeacher   User?                  @relation("MainTeacher", fields: [mainTeacherId], references: [id])
  bookings      CourseSessionBooking[]
  slots         SessionSlot[]

  @@index([courseId])
  @@index([startDate])
  @@index([mainTeacherId])
}

model SessionSlot {
  id         String        @id @default(cuid())
  sessionId  String
  moduleId   String?
  teacherId  String?
  start      DateTime
  end        DateTime
  location   String?
  meetingUrl String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  module     Module?       @relation(fields: [moduleId], references: [id])
  session    CourseSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  teacher    User?         @relation(fields: [teacherId], references: [id])

  @@index([sessionId])
  @@index([teacherId])
  @@index([start])
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model CourseSessionBooking {
  id              String        @id @default(cuid())
  courseSessionId String
  userId          String
  status          String        @default("BOOKED")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  justification   String?
  courseSession   CourseSession @relation(fields: [courseSessionId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseSessionId, userId])
  @@index([courseSessionId])
  @@index([userId])
}

model PaymentLink {
  id              String    @id @default(cuid())
  userId          String
  courseId        String?
  stripeSessionId String    @unique
  stripeUrl       String
  amount          Float
  status          String    @default("PENDING")
  expiresAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  justification   String?
  course          Course?   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model LessonProgress {
  id             String   @id @default(cuid())
  isCompleted    Boolean  @default(false)
  userId         String
  lessonId       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastAccessedAt DateTime @default(now())
  timeSpent      Int      @default(0)
  lesson         Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  status    String   @default("ACTIVE")
  progress  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
}

model Order {
  id              String      @id @default(cuid())
  userId          String
  courseId        String?
  amount          Float
  currency        String      @default("EUR")
  status          String      @default("PENDING")
  stripeSessionId String?     @unique
  stripePaymentId String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  couponId        String?
  coupon          Coupon?     @relation(fields: [couponId], references: [id])
  course          Course?     @relation(fields: [courseId], references: [id])
  user            User        @relation(fields: [userId], references: [id])
  items           OrderItem[]
  payments        Payment[]

  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([createdAt])
  @@index([couponId])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  courseId  String
  quantity  Int      @default(1)
  unitPrice Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id])
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([courseId])
}

model LegacyVehicle {
  id          String    @id @default(cuid())
  model       String
  brand       String
  type        String
  pricePerDay Float
  status      String    @default("AVAILABLE")
  image       String?
  features    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  bookings    Booking[]

  @@index([status])
}

model Booking {
  id          String         @id @default(cuid())
  userId      String
  courseId    String?
  vehicleId   String?
  startDate   DateTime
  endDate     DateTime?
  status      String         @default("PENDING")
  totalAmount Float
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  course      Course?        @relation(fields: [courseId], references: [id])
  user        User           @relation(fields: [userId], references: [id])
  vehicle     LegacyVehicle? @relation(fields: [vehicleId], references: [id])

  @@index([userId])
  @@index([courseId])
  @@index([vehicleId])
  @@index([status])
  @@index([startDate])
}

model Session {
  id        String           @id @default(cuid())
  courseId  String
  teacherId String?
  startsAt  DateTime
  endsAt    DateTime
  mode      String           @default("IN_PERSON")
  location  String?
  maxSeats  Int?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  course    Course           @relation(fields: [courseId], references: [id])
  teacher   User?            @relation("TeacherSessions", fields: [teacherId], references: [id])
  bookings  SessionBooking[]

  @@index([courseId])
  @@index([teacherId])
  @@index([startsAt])
}

model SessionBooking {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  status    String   @default("BOOKED")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  session   Session  @relation(fields: [sessionId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([sessionId])
  @@index([userId])
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String?
  message   String
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

model UserDocument {
  id              String    @id @default(cuid())
  userId          String
  type            String
  fileUrl         String
  status          String    @default("PENDING")
  uploadedAt      DateTime  @default(now())
  reviewedAt      DateTime?
  rejectionReason String?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([status])
}

model Address {
  id         String  @id @default(cuid())
  userId     String?
  label      String?
  line1      String
  line2      String?
  postalCode String
  city       String
  country    String
  isDefault  Boolean @default(false)
  user       User?   @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Payment {
  id                String   @id @default(cuid())
  orderId           String
  provider          String
  providerPaymentId String
  status            String   @default("PENDING")
  amount            Float
  currency          String   @default("EUR")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model Coupon {
  id          String    @id @default(cuid())
  code        String    @unique
  description String?
  discountPct Int?
  discountAmt Float?
  validFrom   DateTime?
  validUntil  DateTime?
  maxUses     Int?
  usedCount   Int       @default(0)
  isActive    Boolean   @default(true)
  orders      Order[]

  @@index([code])
  @@index([isActive])
}

model ConsentLog {
  id          String   @id @default(cuid())
  userId      String
  consentType String
  isGranted   Boolean
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DataExportRequest {
  id        String   @id @default(cuid())
  userId    String
  status    String   @default("PENDING")
  exportUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Quiz {
  id           String        @id @default(cuid())
  title        String
  description  String?
  passingScore Int           @default(80)
  isPublished  Boolean       @default(true)
  courseId     String?
  moduleId     String?       @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  questions    Question[]
  course       Course?       @relation(fields: [courseId], references: [id])
  module       Module?       @relation(fields: [moduleId], references: [id])
  quizAttempts QuizAttempt[]

  @@index([courseId])
}

model QuizAttempt {
  id          String   @id @default(cuid())
  userId      String
  quizId      String
  score       Int      @default(0)
  isPassed    Boolean  @default(false)
  answers     Json     @default("{}")
  startedAt   DateTime @default(now())
  completedAt DateTime @default(now())
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
}

model Question {
  id        String   @id @default(cuid())
  text      String
  type      String   @default("SINGLE")
  position  Int      @default(0)
  quizId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  options   Option[]
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
}

model Option {
  id         String   @id @default(cuid())
  text       String
  isCorrect  Boolean  @default(false)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model InstructorProfile {
  id                          String                   @id @default(cuid())
  userId                      String                   @unique
  specialty                   String                   @default("DRIVING")
  city                        String
  department                  String
  postalCode                  String?
  licenseTypes                String[]                 @default([])
  vehicleType                 String?
  maxStudentsPerWeek          Int?                     @default(20)
  isActive                    Boolean                  @default(true)
  createdAt                   DateTime                 @default(now())
  updatedAt                   DateTime                 @updatedAt
  currentInstructorRequests   ChangeRequest[]          @relation("CurrentInstructor")
  requestedInstructorRequests ChangeRequest[]          @relation("RequestedInstructor")
  drivingLessons              DrivingLesson[]
  assignments                 InstructorAssignment[]
  availabilities              InstructorAvailability[]
  user                        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicles                    Vehicle[]
}

model InstructorAvailability {
  id                String            @id @default(cuid())
  instructorId      String
  date              DateTime?
  startTime         String
  endTime           String
  isRecurring       Boolean           @default(false)
  recurrencePattern String?
  recurrenceDays    Int[]             @default([])
  recurrenceEndDate DateTime?
  isBooked          Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lessons           DrivingLesson[]
  instructor        InstructorProfile @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@index([instructorId, date])
  @@index([instructorId, isBooked])
}

model InstructorAssignment {
  id               String            @id @default(cuid())
  studentId        String
  instructorId     String
  courseType       String
  assignedBy       String?
  assignmentReason String?
  isActive         Boolean           @default(true)
  startDate        DateTime          @default(now())
  endDate          DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  instructor       InstructorProfile @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  student          User              @relation("StudentAssignments", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, instructorId, courseType, isActive])
  @@index([studentId, isActive])
  @@index([instructorId, isActive])
}

model DrivingLesson {
  id                   String                  @id @default(cuid())
  studentId            String
  instructorId         String
  availabilityId       String?
  date                 DateTime
  startTime            String
  endTime              String
  duration             Int
  meetingPoint         String?
  city                 String
  status               String                  @default("PENDING")
  studentConfirmed     Boolean                 @default(false)
  instructorConfirmed  Boolean                 @default(false)
  confirmedAt          DateTime?
  cancelledAt          DateTime?
  cancelledBy          String?
  cancellationReason   String?
  isUrgentCancellation Boolean                 @default(false)
  urgencyValidatedBy   String?
  isDeducted           Boolean                 @default(false)
  reminderSent         Boolean                 @default(false)
  instructorNotes      String?
  studentNotes         String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  vehicleId            String?
  availability         InstructorAvailability? @relation(fields: [availabilityId], references: [id])
  instructor           InstructorProfile       @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  student              User                    @relation("StudentLessons", fields: [studentId], references: [id], onDelete: Cascade)
  vehicle              Vehicle?                @relation(fields: [vehicleId], references: [id])

  @@index([studentId, date])
  @@index([instructorId, date])
  @@index([status])
}

model ChangeRequest {
  id                    String             @id @default(cuid())
  studentId             String
  currentInstructorId   String
  requestedInstructorId String?
  reason                String
  details               String?
  preferredGender       String?
  status                String             @default("PENDING")
  reviewedBy            String?
  reviewedAt            DateTime?
  reviewNotes           String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  currentInstructor     InstructorProfile  @relation("CurrentInstructor", fields: [currentInstructorId], references: [id], onDelete: Cascade)
  requestedInstructor   InstructorProfile? @relation("RequestedInstructor", fields: [requestedInstructorId], references: [id])
  student               User               @relation("StudentChangeRequests", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, status])
  @@index([status])
}

model Vehicle {
  id                    String               @id @default(cuid())
  model                 String
  brand                 String
  status                String               @default("ACTIVE")
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  assignedInstructorId  String?
  currentKm             Int                  @default(0)
  fuelType              String
  insuranceCompany      String?
  insuranceExpiryDate   DateTime?
  insurancePolicyNumber String?
  isAvailable           Boolean              @default(true)
  lastMaintenanceDate   DateTime?
  licensePlate          String               @unique
  maintenanceDueKm      Int?
  nextMaintenanceDate   DateTime?
  technicalControlDate  DateTime?
  transmission          String
  year                  Int
  lessons               DrivingLesson[]
  assignedInstructor    InstructorProfile?   @relation(fields: [assignedInstructorId], references: [id])
  maintenanceRecords    VehicleMaintenance[]

  @@index([status, isAvailable])
  @@index([assignedInstructorId])
}

model VehicleMaintenance {
  id            String    @id @default(cuid())
  vehicleId     String
  type          String
  description   String
  cost          Float?
  performedBy   String?
  performedAt   DateTime
  nextDueDate   DateTime?
  kilometers    Int?
  invoiceNumber String?
  notes         String?
  createdAt     DateTime  @default(now())
  vehicle       Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, performedAt])
}
